# Story 2.2: Enhanced Error Handling and User Experience

## Status
In Progress

## Story
**As a** Claude Code user,  
**I want** clear, actionable error messages and helpful guidance when n8n MCP tools encounter issues,  
**so that** I can quickly understand and resolve problems without frustration.

## Acceptance Criteria
1. **User-Friendly Error Messages**: All error messages provide clear explanations in human-readable language
2. **Actionable Troubleshooting**: Every error includes specific steps the user can take to resolve the issue
3. **Context-Aware Help**: Error messages include relevant context about what the tool was trying to do
4. **Progressive Error Detail**: Basic error for quick understanding, detailed technical info available on request
5. **Configuration Validation**: Proactive validation with helpful setup guidance for common configuration issues
6. **Recovery Suggestions**: When possible, suggest alternative approaches or workarounds
7. **Error Classification**: Errors categorized by type (configuration, network, API, user input) for better UX

## Tasks / Subtasks
- [ ] **Task 1: Error Message Enhancement** (AC: 1, 3, 4)
  - [ ] Replace technical error codes with user-friendly explanations
  - [ ] Add contextual information about what operation failed and why
  - [ ] Implement progressive error detail (summary + expanded technical details)
  - [ ] Create error message templates for common scenarios

- [ ] **Task 2: Troubleshooting Guidance System** (AC: 2, 6)
  - [ ] Add specific troubleshooting steps for n8n API connection failures
  - [ ] Implement configuration validation with setup guidance
  - [ ] Create recovery suggestions for common failure scenarios
  - [ ] Add links to relevant documentation or setup guides

- [ ] **Task 3: Proactive Configuration Validation** (AC: 5)
  - [ ] Enhance `validate_mcp_config` tool with comprehensive checks
  - [ ] Add startup configuration validation with helpful error messages
  - [ ] Implement API key validation with clear setup instructions
  - [ ] Create configuration health check with recommendation system

- [ ] **Task 4: Error Classification and Routing** (AC: 7)
  - [ ] Categorize errors by type (config, network, API, validation, user input)
  - [ ] Implement error-specific response formatting and guidance
  - [ ] Add error severity levels (warning, error, critical) with appropriate messaging
  - [ ] Create error analytics for identifying common user issues

- [ ] **Task 5: User Experience Testing and Optimization** (AC: 1-7)
  - [ ] Test error scenarios with real user workflows
  - [ ] Validate error message clarity and actionability
  - [ ] Optimize error response formats for Claude Code integration
  - [ ] Implement user feedback collection for error experiences

## Dev Notes

### Architecture Context
Enhanced error handling builds on the existing `N8NMcpError` foundation while dramatically improving user experience [Source: docs/architecture.md#coding-standards].

**Current Error Handling Pattern**:
```typescript
// Current technical error (not user-friendly)
throw new N8NMcpError(
  'n8n API operation failed',
  'N8N_API_ERROR',
  500,
  { operation: 'get_workflows' }
)
```

**Enhanced Error Handling Pattern**:
```typescript
// New user-friendly error with guidance
throw new EnhancedN8NMcpError({
  message: "Unable to retrieve workflows from your n8n instance",
  userGuidance: [
    "Check that your n8n instance is running and accessible",
    "Verify your N8N_API_URL is correct: https://your-n8n-instance.com",
    "Confirm your N8N_API_KEY has proper permissions",
    "Test connectivity: curl -H 'Authorization: Bearer YOUR_KEY' YOUR_URL/api/v1/workflows"
  ],
  category: 'connectivity',
  severity: 'error',
  technicalDetails: { originalError: error.message, endpoint: '/workflows' }
})
```

### Error Categories and User Experience

**Error Classification System**:

1. **Configuration Errors**:
   - Missing or invalid API credentials
   - Incorrect n8n instance URL
   - Permission issues
   - *User Experience*: Clear setup instructions with examples

2. **Network/Connectivity Errors**:
   - n8n instance unreachable
   - Timeout issues
   - DNS resolution problems
   - *User Experience*: Network troubleshooting steps

3. **API Errors**:
   - n8n API rate limiting
   - Invalid API requests
   - n8n instance errors
   - *User Experience*: API-specific guidance and workarounds

4. **User Input Errors**:
   - Invalid workflow IDs
   - Malformed parameters
   - Missing required fields
   - *User Experience*: Input format examples and validation

### Enhanced Error Response Format

**MCP Error Response Structure**:
```typescript
interface EnhancedMcpErrorResponse {
  content: [{
    type: 'text',
    text: string // User-friendly error message with guidance
  }],
  error: {
    category: 'config' | 'network' | 'api' | 'input' | 'system',
    severity: 'warning' | 'error' | 'critical',
    userMessage: string,
    troubleshooting: string[],
    technicalDetails?: object,
    suggestedActions: string[],
    helpResources?: string[]
  }
}
```

**Example Enhanced Error Responses**:

```typescript
// Configuration Error Example
{
  content: [{
    type: 'text',
    text: `ðŸ”§ n8n Configuration Issue

Unable to connect to your n8n instance. This usually means your setup needs attention.

Quick Fix:
1. Check your .mcp.json file contains valid n8n credentials
2. Verify your n8n instance is running at: ${config.n8nApiUrl}
3. Test your API key has proper permissions

Need help? The validate_mcp_config tool can check your setup automatically.`
  }],
  error: {
    category: 'config',
    severity: 'error',
    troubleshooting: [
      "Verify N8N_API_URL points to your running n8n instance",
      "Check N8N_API_KEY is a valid JWT token with API permissions",
      "Ensure n8n instance allows API access (not localhost-only)",
      "Test connection: curl -H 'Authorization: Bearer YOUR_KEY' YOUR_URL/health"
    ]
  }
}
```

### File Locations and Implementation

**Enhanced Error System Structure**:
```
src/
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ enhanced-error-handler.ts    # Extend existing error handler
â”‚   â””â”€â”€ error-guidance.ts           # NEW: User guidance and troubleshooting
â”œâ”€â”€ n8n/
â”‚   â””â”€â”€ error-classifier.ts         # NEW: Error categorization logic
â””â”€â”€ tools/
    â””â”€â”€ error-formatters.ts          # NEW: MCP-specific error formatting
```

### Configuration Validation Enhancement

**Enhanced `validate_mcp_config` Tool**:
```typescript
async function validateMcpConfig(args: { fix?: boolean }) {
  const issues = []
  const recommendations = []
  
  // Check API URL format and accessibility
  if (!config.n8nApiUrl) {
    issues.push({
      type: 'missing_config',
      message: 'N8N_API_URL not configured',
      fix: 'Add N8N_API_URL=https://your-n8n-instance.com to your .mcp.json'
    })
  }
  
  // Test API connectivity
  try {
    await enhancedApi.testConnection()
    recommendations.push('âœ… n8n API connection successful')
  } catch (error) {
    issues.push({
      type: 'connectivity',
      message: 'Cannot connect to n8n API',
      troubleshooting: [
        'Check if n8n instance is running',
        'Verify URL is accessible from this machine',
        'Confirm API key has proper permissions'
      ]
    })
  }
  
  return formatConfigValidationResponse(issues, recommendations)
}
```

### Testing Requirements

**Error Scenario Testing**:
```typescript
describe('Enhanced Error Handling', () => {
  test('configuration errors provide helpful guidance', async () => {
    // Simulate missing API key
    const result = await mcpTool('get_n8n_workflows', {})
    
    expect(result.error.category).toBe('config')
    expect(result.error.troubleshooting).toContain('Check N8N_API_KEY')
    expect(result.content[0].text).toContain('Quick Fix:')
  })
  
  test('network errors include connectivity troubleshooting', async () => {
    // Simulate network failure
    const result = await mcpTool('get_n8n_workflows', {})
    
    expect(result.error.category).toBe('network')
    expect(result.error.troubleshooting).toContain('curl')
  })
})
```

### User Experience Validation

**UX Testing Scenarios**:
1. **New User Setup**: Test error messages for common setup mistakes
2. **Network Issues**: Validate guidance for connectivity problems
3. **API Permission Problems**: Check troubleshooting for access issues
4. **Input Validation**: Verify helpful error messages for invalid inputs

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-26 | 1.0 | Initial story creation for enhanced error handling | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*Results from QA Agent review will be added here after story completion*